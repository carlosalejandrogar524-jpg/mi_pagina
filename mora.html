<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mora | Sucursal Amaya</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { background-color:#eef2f6; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;}
.navbar-title { width:100%; text-align:center; font-weight:700; color:#1f2937; font-size:1.3rem;}
.content-container { margin-top:2rem; background:#fff; border-radius:1rem; padding:2rem; box-shadow:0 4px 10px rgba(0,0,0,0.1);}
h1 { color:#1e3a8a; font-weight:700; margin-bottom:1rem; text-align:center; font-size:1.4rem;}
.btn-custom { border:none; border-radius:0; font-weight:600; padding:0.5rem 1.2rem; transition:all 0.2s ease-in-out; font-size:0.95rem;}
.btn-buscar { background-color:#2563eb; color:white; box-shadow:0 3px 6px rgba(37,99,235,0.3);}
.btn-buscar:hover { background-color:#1d4ed8; transform:scale(1.03);}
.btn-secundario { background-color:#fce7f3; color:#1f2937; box-shadow:0 3px 6px rgba(0,0,0,0.1);}
.btn-secundario:hover { background-color:#fcd5e0; transform:scale(1.03);}
.cliente-box { background-color:#dbeafe; border-radius:1rem; padding:1.8rem; box-shadow:inset 0 0 10px rgba(37,99,235,0.3); margin-top:1.5rem; max-width:900px; margin:auto; border:2px solid #93c5fd;}
#resumenCliente { background:#f0f9ff; border:2px solid #93c5fd; border-radius:10px; padding:15px; margin-top:20px; text-align:left; display:none;}
#estadoCarga { text-align:center; color:#1e3a8a; font-weight:600; margin-top:1rem;}

/* === NUEVOS ESTILOS PARA CLASIFICACI√ìN DE MORA === */
.mora-container {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 2rem;
  margin-bottom: 1.5rem;
}

.mora-card {
  width: 220px;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.mora-card-dia, .mora-card-info {
  background-color: #f5f5f5; /* gris claro */
  color: #1f2937;             /* texto oscuro */
  padding: 1rem;
  text-align: center;
  border: 1px solid #d1d5db; /* borde gris neutro */
  cursor: pointer;
  font-weight: 600;
  border-radius: 0; /* RECTANGULAR */
  transition: all 0.2s ease;
}
.mora-card-dia:hover, .mora-card-info:hover { 
  background-color: #e5e7eb; /* gris un poco m√°s oscuro al pasar el mouse */
}

/* caja de cliente */
.cliente-box { 
  background-color: #ffffff; /* blanco */
  border-radius: 10px; 
  padding: 1.8rem; 
  box-shadow: 0 2px 6px rgba(0,0,0,0.1); 
  margin-top: 1.5rem; 
  max-width: 900px; 
  margin:auto; 
  border:1px solid #d1d5db; /* borde gris suave */
}

/* resumen del cliente */
#resumenCliente { 
  background:#f9fafb; /* gris muy claro */
  border:1px solid #d1d5db; 
  border-radius:10px; 
  padding:15px; 
  margin-top:20px; 
  text-align:left; 
  display:none;
}
</style></head>
<body>

<nav class="navbar navbar-light sticky-top bg-light shadow">
  <div class="container w-100">
    <div class="navbar-title mx-auto font-weight-bold text-primary">
      DEPARTAMENTO DE COBROS - SUCURSAL AMAYA
    </div>
  </div>
</nav>

<div class="container content-container">
  <h1>üí≥ CONSULTA DE CLIENTES EN MORA</h1>

  <!-- === SECCI√ìN CLASIFICACI√ìN DE MORA === -->
  <div class="mora-container">
    <div class="mora-card">
      <div class="mora-card-dia" id="btn30">1 - 30 DIAS</div>
      <div class="mora-card-info" id="info30">CLIENTES: 0<br>DEUDA TOTAL: $0.00</div>
    </div>
    <div class="mora-card">
      <div class="mora-card-dia" id="btn60">31 - 60 DIAS</div>
      <div class="mora-card-info" id="info60">CLIENTES: 0<br>DEUDA TOTAL: $0.00</div>
    </div>
    <div class="mora-card">
      <div class="mora-card-dia" id="btn90">61 - 90 DIAS</div>
      <div class="mora-card-info" id="info90">CLIENTES: 0<br>DEUDA TOTAL: $0.00</div>
    </div>
    <div class="mora-card">
      <div class="mora-card-dia" id="btn91">91 DIAS O MAS</div>
      <div class="mora-card-info" id="info91">CLIENTES: 0<br>DEUDA TOTAL: $0.00</div>
    </div>
  </div>

  <p style="text-align:center;">Escriba el n√∫mero de tarjeta y presione <strong>Buscar</strong> para ver la informaci√≥n del cliente.</p>

  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
    <div class="d-flex align-items-center mb-2">
      <input type="text" id="numeroTarjeta" class="form-control mr-2" placeholder="Ingrese n√∫mero de tarjeta..." style="max-width:220px;">
      <button class="btn btn-custom btn-buscar" id="btnBuscar">üîç N√öMERO DE TARJETA</button>
    </div>
    <div class="d-flex gap-2 flex-wrap">
      <button class="btn btn-custom btn-secundario" id="btnGenerarReporte">üìä GENERAR REPORTE DE MORA</button>
      <button class="btn btn-custom btn-buscar" id="btnEstadoCuenta">üìÑ GENERAR ESTADO DE CUENTA</button>
    </div>
  </div>

  <div class="cliente-box">
    <div id="resumenCliente"></div>
    <div id="estadoCarga">‚è≥ Cargando datos desde Google Sheets...</div>
  </div>
</div>

<script>
const SHEET_URL_RAW = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRbmVB9wmGK70VAeV9IfsKPbrtHSSGkpoyudYQkqaGVjBUxso-c5MmtBV6j-0qUxbrr4ws6P3GsSklK/pub?gid=1512254828&single=true&output=csv";
const SHEET_URL = "https://api.codetabs.com/v1/proxy?quest=" + encodeURIComponent(SHEET_URL_RAW);

let clientes = [];
let datosCargados = false;

function parseCSV(text) {
  const rows = text.trim().split(/\r?\n/).map(r => r.split(','));
  const headers = rows[0].map(h => h.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,''));
  return rows.slice(1).map(r => {
    const obj = {};
    headers.forEach((h,i)=> obj[h]=r[i]?r[i].trim():'');
    return obj;
  });
}

function parseCurrency(str){
  if(!str) return 0;
  let num = parseFloat(str.replace(/[^0-9.-]+/g,''));
  return isNaN(num)?0:num;
}

function formatNumber(num){ return Number(num).toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2}); }

async function cargarDatos(){
  try{
    const res = await fetch(SHEET_URL);
    const text = await res.text();
    clientes = parseCSV(text);
    datosCargados = true;
    document.getElementById("estadoCarga").textContent = `‚úÖ Datos cargados correctamente (${clientes.length} registros)`;
    document.getElementById("estadoCarga").style.color = "green";

    actualizarMora();
  } catch(err){
    console.error(err);
    document.getElementById("estadoCarga").textContent = "‚ùå Error al cargar los datos.";
    document.getElementById("estadoCarga").style.color = "red";
  }
}

function actualizarMora(){
  const rangos = { "30":{clientes:0,deuda:0}, "60":{clientes:0,deuda:0}, "90":{clientes:0,deuda:0}, "91":{clientes:0,deuda:0} };
  clientes.forEach(c=>{
    const dias = parseInt(c['diaspendientes'])||0;
    const deuda = parseCurrency(c['deudatotal']);
    if(dias>=1 && dias<=30){ rangos["30"].clientes++; rangos["30"].deuda+=deuda; }
    else if(dias>=31 && dias<=60){ rangos["60"].clientes++; rangos["60"].deuda+=deuda; }
    else if(dias>=61 && dias<=90){ rangos["90"].clientes++; rangos["90"].deuda+=deuda; }
    else if(dias>=91){ rangos["91"].clientes++; rangos["91"].deuda+=deuda; }
  });

  document.getElementById("info30").innerHTML=`CLIENTES: ${rangos["30"].clientes.toLocaleString()}<br>DEUDA TOTAL: $${formatNumber(rangos["30"].deuda)}`;
  document.getElementById("info60").innerHTML=`CLIENTES: ${rangos["60"].clientes.toLocaleString()}<br>DEUDA TOTAL: $${formatNumber(rangos["60"].deuda)}`;
  document.getElementById("info90").innerHTML=`CLIENTES: ${rangos["90"].clientes.toLocaleString()}<br>DEUDA TOTAL: $${formatNumber(rangos["90"].deuda)}`;
  document.getElementById("info91").innerHTML=`CLIENTES: ${rangos["91"].clientes.toLocaleString()}<br>DEUDA TOTAL: $${formatNumber(rangos["91"].deuda)}`;
}

function abrirLista(rango){ window.open(`lista_clientes.html?rango=${rango}`,'_blank'); }

document.getElementById("btn30").addEventListener("click", ()=>abrirLista("30"));
document.getElementById("info30").addEventListener("click", ()=>abrirLista("30"));
document.getElementById("btn60").addEventListener("click", ()=>abrirLista("60"));
document.getElementById("info60").addEventListener("click", ()=>abrirLista("60"));
document.getElementById("btn90").addEventListener("click", ()=>abrirLista("90"));
document.getElementById("info90").addEventListener("click", ()=>abrirLista("90"));
document.getElementById("btn91").addEventListener("click", ()=>abrirLista("91"));
document.getElementById("info91").addEventListener("click", ()=>abrirLista("91"));

document.getElementById("btnEstadoCuenta").addEventListener("click", ()=>{
  const numero = document.getElementById("numeroTarjeta").value.trim();
  if(!numero){ alert("Ingrese un n√∫mero de tarjeta para generar el Estado de Cuenta."); return; }
  const url = `estado_cuenta.html?tarjeta=${encodeURIComponent(numero)}`;
  window.open(url,'_blank');
});

document.getElementById("btnBuscar").addEventListener("click", ()=>{
  const val = document.getElementById("numeroTarjeta").value.trim();
  const estado = document.getElementById("estadoCarga");
  const resumen = document.getElementById("resumenCliente");
  if(!val){ estado.textContent="‚ö†Ô∏è INGRESE UN NUMERO DE TARJETA."; estado.style.color="orange"; resumen.style.display="none"; return;}
  if(!datosCargados){ estado.textContent="‚è≥ AUN CARGANDO LOS DATOS..."; estado.style.color="orange"; resumen.style.display="none"; return;}
  const cliente = clientes.find(c=>c['numerodetarjeta']===val);
  if(cliente){
    estado.textContent="‚úÖ CLIENTE ENCONTRADO."; estado.style.color="green";
    resumen.innerHTML = `<h5>RESUMEN DEL CLIENTE</h5>
      <p><strong>N√öMERO DE TARJETA:</strong> ${cliente['numerodetarjeta']||'N/A'}</p>
      <p><strong>NOMBRE:</strong> ${cliente['nombrecliente']||'N/A'}</p>
      <p><strong>TELEFONO:</strong> ${cliente['telefono']||'N/A'}</p>
      <p><strong>DIRECCION:</strong> ${cliente['direccion']||'N/A'}</p>
      <p><strong>DIAS PENDIENTES:</strong> ${cliente['diaspendientes']||'0'}</p>
      <p><strong>DEUDA TOTAL:</strong> $${formatNumber(parseCurrency(cliente['deudatotal']))}</p>`;
    resumen.style.display="block";
  }else{
    estado.textContent="‚ùå CLIENTE NO ENCONTRADO."; estado.style.color="red"; resumen.style.display="none";
  }
});

cargarDatos();
</script>

</body>
</html>
