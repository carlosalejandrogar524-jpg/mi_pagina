<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cr√©ditos Otorgados</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { background-color:#f8f9fa; }
  .table th, .table td { text-align:center; font-size:0.9rem; }
  .container { margin-top:1.5rem; }
  .small-muted { color:#666; margin-bottom:0.75rem; display:block; }
</style>
</head>
<body>
<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div>
      <h4 class="mb-0">Cr√©ditos Otorgados ‚Äî <small id="empleadoNombre">Empleado</small></h4>
      <span class="small-muted">Datos cargados autom√°ticamente desde Google Sheets</span>
    </div>
    <div>
      <button id="btnBack" class="btn btn-outline-secondary btn-sm">‚Üê Volver</button>
    </div>
  </div>

  <div id="alertBox" style="display:none" class="mb-3"></div>

  <div class="table-responsive mt-2">
    <table class="table table-striped table-bordered">
      <thead class="thead-dark">
        <tr>
          <th>MES</th>
          <th>GESTOR</th>
          <th>CLIENTE</th>
          <th>DUI</th>
          <th>TEL√âFONO</th>
          <th>DIRECCI√ìN</th>
          <th>FECHA DE APROBACI√ìN</th>
          <th>PRODUCTO</th>
          <th>PRIMA</th>
          <th>MONTO POR CUOTA</th>
        </tr>
      </thead>
      <tbody id="tbodyCreditos">
        <tr><td colspan="10">Cargando cr√©ditos...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
// --- CONFIGURACI√ìN ---
// Nuevo enlace de tu hoja de cr√©ditos üëá
const csvUrlRaw = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTUW4J2HxFjjHfPwC_QdcaPNtqNnW7ZGezgMHqGm8SIw3STfzDoc7AbXlSLhAqpPib6IDiRNYrgT11-/pub?gid=1371742498&single=true&output=csv";
const proxyUrl = "https://api.codetabs.com/v1/proxy?quest=";
const csvUrl = proxyUrl + encodeURIComponent(csvUrlRaw);

// Obtener nombre de empleado desde URL (?empleado=Juan%20Perez)
const urlParams = new URLSearchParams(window.location.search);
const empleado = urlParams.get('empleado') ? decodeURIComponent(urlParams.get('empleado')) : "";
document.getElementById('empleadoNombre').textContent = empleado || "No definido";

// Bot√≥n volver
document.getElementById('btnBack').addEventListener('click', () => window.history.back());

// Mostrar alertas
function showAlert(msg, type='danger'){
  const box = document.getElementById('alertBox');
  box.style.display = 'block';
  box.innerHTML = `<div class="alert alert-${type}" role="alert">${msg}</div>`;
}

// --- Funciones de utilidad ---
function parseCSV(text){
  const rows = [];
  let cur = '', row = [], inQuotes = false;
  for (let i = 0; i < text.length; i++){
    const ch = text[i], next = text[i+1];
    if (ch === '"'){
      if (inQuotes && next === '"'){ cur += '"'; i++; }
      else { inQuotes = !inQuotes; }
      continue;
    }
    if (ch === ',' && !inQuotes){ row.push(cur); cur=''; continue; }
    if ((ch === '\n' || ch === '\r') && !inQuotes){
      if (cur !== '' || row.length > 0){ row.push(cur); rows.push(row); row=[]; cur=''; }
      continue;
    }
    cur += ch;
  }
  if (cur !== '' || row.length > 0){ row.push(cur); rows.push(row); }
  return rows.filter(r => r.length > 1 || (r.length === 1 && r[0].trim() !== ""));
}

function csvRowsToObjects(rows){
  if (!rows || rows.length === 0) return [];
  const headers = rows[0].map(h => h ? h.trim() : "");
  return rows.slice(1).map(r => {
    const obj = {};
    headers.forEach((h, i) => obj[h] = (r[i] || "").trim());
    return obj;
  });
}

function getField(row, ...names){
  const keys = Object.keys(row);
  const normalize = s => s ? s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim().toLowerCase() : '';
  for (const name of names){
    const norm = normalize(name);
    for (const k of keys){
      if (normalize(k) === norm) return row[k];
    }
  }
  return "";
}

// --- Cargar CSV ---
async function fetchCSV(){
  const res = await fetch(csvUrl);
  if (!res.ok) throw new Error(`Error HTTP ${res.status}`);
  const text = await res.text();
  if (text.trim().startsWith("{")){
    try {
      const json = JSON.parse(text);
      if (json.contents) return json.contents;
    } catch(e){ console.warn("JSON inv√°lido", e); }
  }
  return text;
}

// --- Cargar Cr√©ditos ---
async function cargarCreditos(){
  const tbody = document.getElementById('tbodyCreditos');
  tbody.innerHTML = `<tr><td colspan="10">Cargando cr√©ditos...</td></tr>`;
  try {
    const csvText = await fetchCSV();
    const rows = parseCSV(csvText);
    const objs = csvRowsToObjects(rows);

    if (!objs.length){
      tbody.innerHTML = `<tr><td colspan="10">No hay cr√©ditos registrados.</td></tr>`;
      return;
    }

    // Filtrar solo los cr√©ditos del gestor actual
    const datosFiltrados = objs.filter(row => {
      const gestor = getField(row, 'GESTOR');
      return gestor && empleado && gestor.toLowerCase() === empleado.toLowerCase();
    });

    if (!datosFiltrados.length){
      tbody.innerHTML = `<tr><td colspan="10">No hay cr√©ditos registrados para ${empleado}.</td></tr>`;
      return;
    }

    tbody.innerHTML = '';
    datosFiltrados.forEach(row=>{
      const mes = getField(row,'MES') || '-';
      const gestor = getField(row,'GESTOR') || '-';
      const cliente = getField(row,'CLIENTE') || '-';
      const dui = getField(row,'DUI') || '-';
      const tel = getField(row,'TELEFONO') || '-';
      const direccion = getField(row,'DIRECCION') || '-';
      const fechaAprob = getField(row,'FECHA DE APROBACION') || '-';
      const producto = getField(row,'PRODUCTO') || '-';
      const prima = getField(row,'PRIMA') || '-';
      const monto = getField(row,'MONTO POR CUOTA') || '-';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${mes}</td>
        <td>${gestor}</td>
        <td>${cliente}</td>
        <td>${dui}</td>
        <td>${tel}</td>
        <td>${direccion}</td>
        <td>${fechaAprob}</td>
        <td>${producto}</td>
        <td>${prima}</td>
        <td>${monto}</td>`;
      tbody.appendChild(tr);
    });

    document.getElementById('alertBox').style.display = 'none';
  } catch (err){
    console.error(err);
    showAlert(`No se pudieron cargar los cr√©ditos: ${err.message}`, 'danger');
    tbody.innerHTML = `<tr><td colspan="10" class="text-danger">Error cargando datos.</td></tr>`;
  }
}

// --- Iniciar ---
cargarCreditos();
setInterval(cargarCreditos,60000);
</script>
</body>
</html>