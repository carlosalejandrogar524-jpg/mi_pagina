<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Créditos — Detalle</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { background:#f8f9fa; font-family:Inter, system-ui; color:#243044; }
.container { margin-top:1.25rem; }
.table th, .table td { text-align:center; vertical-align:middle; font-size:0.95rem; }
.small-muted { color:#666; display:block; margin-bottom:.6rem; }
.totales { font-weight:800; background:#f1f3f5; }
</style>
</head>
<body>
<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div>
      <h4 class="mb-0 text-primary">Créditos — <small id="empleadoNombre">Cargando...</small></h4>
      <span class="small-muted">Datos cargados automáticamente desde Google Sheets</span>
    </div>
    <div>
      <button id="btnBack" class="btn btn-outline-secondary btn-sm">← Volver</button>
    </div>
  </div>

  <div id="alertBox" style="display:none" class="mb-3"></div>

  <div class="table-responsive">
    <table class="table table-striped table-bordered">
      <thead class="thead-dark">
        <tr>
          <th>MES</th>
          <th>GESTOR</th>
          <th>NUMERO DE TARJETA</th>
          <th>CLIENTE</th>
          <th>DUI</th>
          <th>TELÉFONO</th>
          <th>MONTO CRÉDITO</th>
          <th>PRODUCTO</th>
          <th>FECHA DE APROBACION</th>
        </tr>
      </thead>
      <tbody id="tbodyCreditos">
        <tr><td colspan="8">Cargando créditos...</td></tr>
      </tbody>
      <tfoot id="tfootCreditos"></tfoot>
    </table>
  </div>
</div>

<script>
// Parámetros URL
const urlParams = new URLSearchParams(window.location.search);
const empleado = urlParams.get('empleado') ? decodeURIComponent(urlParams.get('empleado')) : "";
const mesSeleccionado = urlParams.get('mes') ? decodeURIComponent(urlParams.get('mes')) : "";
document.getElementById('empleadoNombre').textContent = empleado || "No definido";
if(mesSeleccionado){
  const sub = document.createElement('small');
  sub.classList.add('text-muted');
  sub.textContent = ` — Mes: ${mesSeleccionado}`;
  document.getElementById('empleadoNombre').appendChild(sub);
}

// Botón volver
document.getElementById('btnBack').addEventListener('click', () => history.back());

// URL CSV de créditos
const csvRaw = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTUW4J2HxFjjHfPwC_QdcaPNtqNnW7ZGezgMHqGm8SIw3STfzDoc7AbXlSLhAqpPib6IDiRNYrgT11-/pub?gid=1371742498&single=true&output=csv";
const proxy = "https://api.codetabs.com/v1/proxy?quest=";
const csvUrl = proxy + encodeURIComponent(csvRaw);

// Funciones auxiliares
function showAlert(msg,type='danger'){
  const box = document.getElementById('alertBox');
  box.style.display = 'block';
  box.innerHTML = `<div class="alert alert-${type}" role="alert">${msg}</div>`;
}

function money(v){ return `$${Number(v||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}`; }
function normalize(s){ return s ? s.toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim().toLowerCase() : ''; }
function toNumber(v){
  if(!v) return 0;
  const n = parseFloat(v.toString().replace(/[^\d.-]/g,''));
  return isNaN(n)?0:n;
}

// Cargar créditos
async function cargarCreditos(){
  const tbody = document.getElementById('tbodyCreditos');
  const tfoot = document.getElementById('tfootCreditos');
  tbody.innerHTML = `<tr><td colspan="8">Cargando créditos...</td></tr>`;
  tfoot.innerHTML = '';

  try{
    const res = await fetch(csvUrl);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const text = await res.text();
    const rows = text.trim().split("\n").map(r => r.split(","));
    const headers = rows.shift();
    const data = rows.map(r=>{
      const obj = {};
      headers.forEach((h,i)=> obj[h.trim()] = r[i]? r[i].trim() : "");
      return obj;
    });

    // Filtrar por empleado
    let filtrados = data.filter(r => normalize(r["GESTOR"])===normalize(empleado));

    // Filtrar por mes si existe parámetro
    if(mesSeleccionado){
      filtrados = filtrados.filter(r => normalize(r["MES"])===normalize(mesSeleccionado));
    }

    if(!filtrados.length){
      tbody.innerHTML = `<tr><td colspan="8">No hay créditos registrados para este empleado${mesSeleccionado ? " en "+mesSeleccionado : ""}.</td></tr>`;
      return;
    }

    tbody.innerHTML = '';
    let sumaTotal = 0;

   filtrados.forEach(r=>{
  const mes = r["MES"] || '-';
  const gestor = r["GESTOR"] || '-';
  const numeroTarjeta = r["NUMERO DE TARJETA"] || '-';
  const cliente = r["CLIENTE"] || '-';
  const dui = r["DUI"] || '-';
  const telefono = r["TELEFONO"] || '-';
  const producto = r["PRODUCTO"] || '-';
  const fecha = r["FECHA DE APROBACION"] || '-';
  const monto = toNumber(r["MONTO POR CUOTA"]);
  sumaTotal += monto;

  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>${mes}</td>
    <td>${gestor}</td>
    <td>${numeroTarjeta}</td>
    <td>${cliente}</td>
    <td>${dui}</td>
    <td>${telefono}</td>
    <td>${money(monto)}</td>
    <td>${producto}</td>
    <td>${fecha}</td>
  `;
  tbody.appendChild(tr);
});

    // Totales
    tfoot.innerHTML = `
      <tr class="totales">
        <td colspan="5" style="text-align:right">TOTAL CRÉDITOS:</td>
        <td>${money(sumaTotal)}</td>
        <td colspan="2"></td>
      </tr>
    `;

  }catch(err){
    console.error(err);
    showAlert(`Error al cargar créditos: ${err.message}`);
    tbody.innerHTML = `<tr><td colspan="8" class="text-danger">Error cargando datos.</td></tr>`;
  }
}

// Ejecutar
cargarCreditos();
setInterval(cargarCreditos,60000);
</script>
</body>
</html>
