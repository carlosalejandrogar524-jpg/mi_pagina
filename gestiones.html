<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gestiones del Gestor</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { background:#f8f9fa; font-family:Inter, system-ui; }
h3 { font-weight:700; color:#243044; }
.table th, .table td { text-align:center; vertical-align:middle; font-size:0.9rem; }
.table thead th { background-color:#0d6efd; color:white; }
.container { margin-top:1.5rem; }
.loading { text-align:center; padding:2rem; color:#6c757d; }
.totales { font-weight:700; background:#eef2f7; }
/* --- estilo del gráfico --- */
#chartGestiones {
  max-height: 180px !important;
}
.chart-container {
  position: relative;
  height: 180px;
}
</style>
</head>
<body>
<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div>
      <h3>Gestiones — <small id="empleadoNombre">Empleado</small></h3>
      <span class="small text-muted">Datos cargados automáticamente desde Google Sheets</span>
    </div>
    <div>
      <button id="btnBack" class="btn btn-outline-secondary btn-sm">← Volver</button>
    </div>
  </div>

  <div id="alertBox" class="mb-3" style="display:none;"></div>

  <!-- CONTENEDOR DEL GRÁFICO -->
  <div class="card mb-3 shadow-sm">
    <div class="card-header bg-white py-2"><strong>Distribución de Gestiones Realizadas</strong></div>
    <div class="card-body p-2 chart-container">
      <canvas id="chartGestiones"></canvas>
    </div>
  </div>

  <div class="table-responsive mt-3">
    <table class="table table-striped table-bordered table-sm">
      <thead>
        <tr>
          <th>MES</th>
          <th>GESTOR</th>
          <th>CLIENTE</th>
          <th>DUI</th>
          <th>TELEFONO</th>
          <th>DIRECCION</th>
          <th>FECHA DE GESTION</th>
          <th>GESTION</th>
          <th>COMENTARIO</th>
        </tr>
      </thead>
      <tbody id="tbodyGestiones">
        <tr><td colspan="9" class="loading">Cargando gestiones...</td></tr>
      </tbody>
      <tfoot id="tfootGestiones"></tfoot>
    </table>
  </div>
</div>

<script>
// -------------------------
// CONFIGURACIÓN
// -------------------------
const csvRaw = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSWc7tNf1MsbdXNCf7_To0EUb25mXuEE-SnH4wg3_cd7Xa_-kYQNJXOvS6vAbzr9EGNOCyI8bw4KIwE/pub?gid=174846463&single=true&output=csv";
const proxy = "https://api.codetabs.com/v1/proxy?quest=";
const csvUrl = proxy + encodeURIComponent(csvRaw);

// Parámetros desde la URL
const params = new URLSearchParams(window.location.search);
const empleado = params.get('empleado') ? decodeURIComponent(params.get('empleado')) : "";
const mesSeleccionado = params.get('mes') ? decodeURIComponent(params.get('mes')) : "";

// Mostrar empleado y mes en la cabecera
document.getElementById('empleadoNombre').textContent = empleado || "No definido";
if (mesSeleccionado) {
  const sub = document.createElement('small');
  sub.classList.add('text-muted');
  sub.textContent = ` — Mes: ${mesSeleccionado}`;
  document.getElementById('empleadoNombre').appendChild(sub);
}

// Botón "Volver"
document.getElementById('btnBack').addEventListener('click', () => window.history.back());

// -------------------------
// FUNCIONES AUXILIARES
// -------------------------
function showAlert(msg, type='danger') {
  const box = document.getElementById('alertBox');
  box.style.display = 'block';
  box.innerHTML = `<div class="alert alert-${type}" role="alert">${msg}</div>`;
}

function normalize(s) {
  return s ? s.normalize('NFD').replace(/[\u0300-\u036f]/g, '').trim().toLowerCase() : '';
}

function csvParse(text) {
  const rows = [];
  let cur = '', row = [], inQuotes = false;
  for (let i = 0; i < text.length; i++) {
    const ch = text[i], next = text[i + 1];
    if (ch === '"') {
      if (inQuotes && next === '"') { cur += '"'; i++; }
      else { inQuotes = !inQuotes; }
      continue;
    }
    if (ch === ',' && !inQuotes) { row.push(cur); cur = ''; continue; }
    if ((ch === '\n' || ch === '\r') && !inQuotes) {
      if (cur !== '' || row.length > 0) { row.push(cur); rows.push(row); row = []; cur = ''; }
      continue;
    }
    cur += ch;
  }
  if (cur !== '' || row.length > 0) { row.push(cur); rows.push(row); }
  return rows.filter(r => r.length > 1 || (r.length === 1 && r[0].trim() !== ""));
}

function rowsToObjects(rows) {
  if (!rows || !rows.length) return [];
  const headers = rows[0].map(h => h.trim());
  return rows.slice(1).map(r => {
    const obj = {};
    headers.forEach((h, i) => obj[h] = r[i] ? r[i].trim() : "");
    return obj;
  });
}

// -------------------------
// CARGAR GESTIONES
// -------------------------
let chartGestiones = null;

async function cargarGestiones() {
  const tbody = document.getElementById('tbodyGestiones');
  const tfoot = document.getElementById('tfootGestiones');
  tbody.innerHTML = `<tr><td colspan="9" class="loading">Cargando gestiones...</td></tr>`;
  tfoot.innerHTML = '';

  try {
    const res = await fetch(csvUrl);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const text = await res.text();
    const rows = csvParse(text);
    const objs = rowsToObjects(rows);

    if (!objs.length) {
      tbody.innerHTML = `<tr><td colspan="9">No hay gestiones registradas.</td></tr>`;
      return;
    }

    const sample = objs[0];
    const gestorKey = Object.keys(sample).find(k => normalize(k).includes('gestor')) || 'GESTOR';
    const mesKey = Object.keys(sample).find(k => normalize(k).includes('mes')) || 'MES';

    let filtrados = objs.filter(r => normalize(r[gestorKey]) === normalize(empleado));
    if (mesSeleccionado) {
      filtrados = filtrados.filter(r => normalize(r[mesKey]) === normalize(mesSeleccionado));
    }

    tbody.innerHTML = '';
    if (!filtrados.length) {
      tbody.innerHTML = `<tr><td colspan="9">No hay gestiones registradas para este empleado${mesSeleccionado ? " en " + mesSeleccionado : ""}.</td></tr>`;
      return;
    }

    filtrados.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r[mesKey] || '-'}</td>
        <td>${r[gestorKey] || '-'}</td>
        <td>${r["CLIENTE"] || '-'}</td>
        <td>${r["DUI"] || '-'}</td>
        <td>${r["TELEFONO"] || '-'}</td>
        <td>${r["DIRECCION"] || '-'}</td>
        <td>${r["FECHA DE GESTION"] || '-'}</td>
        <td>${r["GESTION"] || '-'}</td>
        <td>${r["COMENTARIO"] || '-'}</td>
      `;
      tbody.appendChild(tr);
    });

    tfoot.innerHTML = `
      <tr class="totales">
        <td colspan="8" style="text-align:right">Total de gestiones realizadas:</td>
        <td>${filtrados.length}</td>
      </tr>
    `;

    renderGraficoGestiones(filtrados);
  } catch (err) {
    console.error(err);
    showAlert("Error al cargar las gestiones: " + err.message);
    tbody.innerHTML = `<tr><td colspan="9" class="text-danger">Error cargando datos.</td></tr>`;
  }
}

// -------------------------
// GRÁFICO DE GESTIONES
// -------------------------
function renderGraficoGestiones(data) {
  const conteo = {};
  data.forEach(r => {
    const tipo = r["GESTION"] ? r["GESTION"].trim() : "Sin especificar";
    conteo[tipo] = (conteo[tipo] || 0) + 1;
  });

  const etiquetas = Object.keys(conteo);
  const valores = Object.values(conteo);

  const ctx = document.getElementById('chartGestiones').getContext('2d');
  if (chartGestiones) chartGestiones.destroy();

  chartGestiones = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: etiquetas,
      datasets: [{
        label: 'Gestiones realizadas',
        data: valores,
        backgroundColor: '#0d6efd'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { font: { size: 10 } }, title: { display: true, text: 'Tipo de gestión', font: { size: 11 } } },
        y: { beginAtZero: true, ticks: { stepSize: 1, font: { size: 10 } }, title: { display: true, text: 'Cantidad', font: { size: 11 } } }
      }
    }
  });
}

cargarGestiones();
setInterval(cargarGestiones, 60000);
</script>
</body>
</html>
