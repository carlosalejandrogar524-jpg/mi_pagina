<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Detalle del Empleado — Gestor</title>

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { background:#f5f7fb; color:#243044; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
.header { display:flex; justify-content:space-between; align-items:center; gap:1rem; margin:1rem 0; }
.title { font-weight:800; font-size:1.25rem; }
.card-kpi { padding:0.8rem; border-radius:.6rem; color:#fff; font-weight:700; text-align:center; }
.bg-rec { background: linear-gradient(90deg,#28a745,#66d28f); }
.bg-obj { background: linear-gradient(90deg,#0d6efd,#66b0ff); }
.bg-fal { background: linear-gradient(90deg,#ffc107,#ffe08a); color:#000; }
.bg-por { background: linear-gradient(90deg,#8e44ad,#a47ee0); }
.table thead th, .table tbody td { text-align:center; vertical-align:middle; }
.btn-linklike { background:none; border:none; color:#0d6efd; font-weight:700; text-decoration:underline; padding:0; cursor:pointer; }
.grafico { height:220px; width:100%; }
.indicator-ok { color:green; font-weight:800; }
.indicator-bad { color:#d9534f; font-weight:800; }
</style>
</head>
<body>

<div class="container">

  <!-- HEADER -->
  <div class="header">
    <div>
      <div class="title">Detalle del Empleado — <span id="empleadoNombre">Cargando...</span></div>
      <small class="text-muted" id="empleadoCargo">Gestor de Cobros — Sucursal</small>
    </div>
    <button class="btn btn-secondary" onclick="history.back()">← Regresar</button>
  </div>

  <!-- KPI -->
  <div class="d-flex flex-wrap gap-2 mb-3">
    <div class="card-kpi bg-rec"><small>Recuperado</small><div id="kpiRec">$0.00</div></div>
    <div class="card-kpi bg-obj"><small>Objetivo</small><div id="kpiObj">$10,000.00</div></div>
    <div class="card-kpi bg-fal"><small>Faltante</small><div id="kpiFal">$0.00</div></div>
    <div class="card-kpi bg-por"><small>% Recuperado</small><div id="kpiPor">0%</div></div>
  </div>

  <!-- TABLA CONSOLIDADO -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-white"><strong>Consolidado de Gestiones por Mes</strong></div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-sm mb-0">
          <thead class="thead-dark">
            <tr>
              <th>Mes</th>
              <th>Recuperado</th>
              <th>Faltante</th>
              <th>Objetivo</th>
              <th>Créditos</th>
              <th>Gestiones</th>
              <th>% Recuperado</th>
            </tr>
          </thead>
          <tbody id="consolidadoTbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- GRÁFICOS -->
  <div class="row mb-4">
    <div class="col-md-4 mb-3"><canvas id="chartPie" class="grafico"></canvas></div>
    <div class="col-md-4 mb-3"><canvas id="chartBar" class="grafico"></canvas></div>
    <div class="col-md-4 mb-3"><canvas id="chartLine" class="grafico"></canvas></div>
  </div>

</div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
// -------------------------
// CONFIG
// -------------------------
const urlParams = new URLSearchParams(window.location.search);
const nombreEmpleado = urlParams.get('empleado') || "Empleado";
document.getElementById('empleadoNombre').textContent = nombreEmpleado;
document.getElementById('empleadoCargo').textContent = "Gestor de Cobros — Sucursal Amaya";

const proxy = "https://api.codetabs.com/v1/proxy?quest=";
const sheetGestiones = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTUW4J2HxFjjHfPwC_QdcaPNtqNnW7ZGezgMHqGm8SIw3STfzDoc7AbXlSLhAqpPib6IDiRNYrgT11-/pub?gid=1371742498&single=true&output=csv";
const sheetRecuperado = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTh4nQC1nPAHgWvJ0SIlL5AhnV4d6v6htBlGQnCJsLvLeC1IsfYDglzJ1JyVKvRAJ6apOEocWmvpsKo/pub?gid=1552374160&single=true&output=csv";

// -------------------------
// UTILIDADES
// -------------------------
function money(v){ return `$${Number(v||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}`; }

function parseCSV(text){
  const rows = text.trim().split("\n").map(r => r.split(",").map(c => c.trim()));
  const headers = rows.shift();
  return rows.map(r => {
    const obj = {};
    headers.forEach((h,i) => obj[h.trim()] = r[i] ? r[i].trim() : "");
    return obj;
  });
}

// -------------------------
// CARGAR DATOS
// -------------------------
async function loadAll(){
  try{
    const gestionesRes = await fetch(proxy + encodeURIComponent(sheetGestiones));
    const recuperadoRes = await fetch(proxy + encodeURIComponent(sheetRecuperado));

    const gestiones = parseCSV(await gestionesRes.text());
    const recuperado = parseCSV(await recuperadoRes.text());

    const dataGestorGest = gestiones.filter(r=>r["GESTOR"]?.toLowerCase().trim()===nombreEmpleado.toLowerCase().trim());
    const dataGestorRec = recuperado.filter(r=>r["GESTOR"]?.toLowerCase().trim()===nombreEmpleado.toLowerCase().trim());

    const meses = [...new Set([...dataGestorGest.map(d=>d["MES"]), ...dataGestorRec.map(d=>d["MES"])]).values()].filter(m=>m);

    const consolidado = meses.map(m=>{
      const pagosMes = dataGestorRec.filter(d=>d["MES"]===m);
      const gestionesMes = dataGestorGest.filter(d=>d["MES"]===m);

      // SUMA RECUPERADO
      const totalRec = pagosMes.reduce((s,p)=>{
        let monto = p["RECUPERADO"] || "0";   
        monto = monto.replace(/\$/g,'').replace(/,/g,'').trim();
        return s + Number(monto || 0);
      },0);

      const objetivo = 10000; // <-- Objetivo fijo
      const faltante = Math.max(0, objetivo - totalRec);
      const porc = ((totalRec/objetivo)*100).toFixed(1);

      return {
        MES: m,
        RECUPERADO: totalRec,
        OBJETIVO: objetivo,
        FALTANTE: faltante,
        CREDITOS: gestionesMes.length,
        GESTIONES: gestionesMes.length,
        PORC: porc
      };
    });

    renderTable(consolidado);
    renderCharts(consolidado);

  } catch(e){
    console.error("Error cargando datos:", e);
    alert("No se pudieron cargar los datos del empleado.");
  }
}

// -------------------------
// RENDER TABLA
// -------------------------
function renderTable(data){
  const tbody = document.getElementById("consolidadoTbody");
  tbody.innerHTML = "";
  data.forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.MES}</td>
      <td>${money(r.RECUPERADO)}<br><button class="btn-linklike" onclick="window.location.href='recuperado.html?empleado=${encodeURIComponent(nombreEmpleado)}'">Ver</button></td>
      <td>${money(r.FALTANTE)}</td>
      <td>${money(r.OBJETIVO)}</td>
      <td>${r.CREDITOS}<br><button class="btn-linklike" onclick="window.location.href='creditos.html?empleado=${encodeURIComponent(nombreEmpleado)}'">Ver</button></td>
      <td>${r.GESTIONES}<br><button class="btn-linklike" onclick="window.location.href='gestiones.html?empleado=${encodeURIComponent(nombreEmpleado)}'">Ver</button></td>
      <td>${r.PORC>=85 ? `<span class='indicator-ok'>${r.PORC}%</span>` : `<span class='indicator-bad'>${r.PORC}%</span>`}</td>
    `;
    tbody.appendChild(tr);
  });

  const totalRec = data.reduce((s,d)=>s+Number(d.RECUPERADO),0);
  const totalObj = 10000; // Fijo
  const totalFal = Math.max(0,totalObj-totalRec);
  const porc = ((totalRec/totalObj)*100).toFixed(1);

  document.getElementById("kpiRec").textContent = money(totalRec);
  document.getElementById("kpiObj").textContent = money(totalObj);
  document.getElementById("kpiFal").textContent = money(totalFal);
  document.getElementById("kpiPor").textContent = porc+"%";
}

// -------------------------
// GRÁFICOS
// -------------------------
let chartPie, chartBar, chartLine;
function renderCharts(data){
  const ctxPie = document.getElementById('chartPie').getContext('2d');
  const ctxBar = document.getElementById('chartBar').getContext('2d');
  const ctxLine = document.getElementById('chartLine').getContext('2d');

  if(chartPie) chartPie.destroy();
  if(chartBar) chartBar.destroy();
  if(chartLine) chartLine.destroy();

  chartPie = new Chart(ctxPie,{type:'pie',data:{labels:data.map(d=>d.MES), datasets:[{data:data.map(d=>d.RECUPERADO)}]}});

  chartBar = new Chart(ctxBar,{type:'bar',data:{labels:data.map(d=>d.MES), datasets:[{label:'Recuperado',data:data.map(d=>d.RECUPERADO)}, {label:'Objetivo', data:data.map(d=>d.OBJETIVO)}]}});

  chartLine = new Chart(ctxLine,{type:'line',data:{labels:data.map(d=>d.MES), datasets:[{label:'Recuperado',data:data.map(d=>d.RECUPERADO)}, {label:'Objetivo', data:data.map(d=>d.OBJETIVO)}]}});

}

document.addEventListener("DOMContentLoaded", loadAll);
</script>

</body>
</html>