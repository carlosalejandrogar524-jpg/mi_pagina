<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Reporte General — Todos los Gestores</title>

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { background:#f5f7fb; color:#243044; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
.header { display:flex; justify-content:space-between; align-items:center; gap:1rem; margin:1rem 0; }
.title { font-weight:800; font-size:1.25rem; }
.card-kpi { padding:0.8rem; border-radius:.6rem; color:#fff; font-weight:700; text-align:center; }
.bg-rec { background: linear-gradient(90deg,#28a745,#66d28f); }
.bg-obj { background: linear-gradient(90deg,#0d6efd,#66b0ff); }
.bg-fal { background: linear-gradient(90deg,#ffc107,#ffe08a); color:#000; }
.bg-por { background: linear-gradient(90deg,#8e44ad,#a47ee0); }
.table thead th, .table tbody td { text-align:center; vertical-align:middle; }
.btn-linklike { background:none; border:none; color:#0d6efd; font-weight:700; text-decoration:underline; padding:0; cursor:pointer; }
.grafico { height:220px; width:100%; }
.indicator-ok { color:green; font-weight:800; }
.indicator-bad { color:#d9534f; font-weight:800; }

/* FILTROS COMPACTOS */
.filtros-container {
  display:flex;
  flex-wrap:wrap;
  gap:0.5rem;
  align-items:center;
  margin-bottom:1rem;
}
.filtros-container label { font-weight:600; margin-right:0.3rem; }
.filtros-container input[type="month"] { height:32px; font-size:0.9rem; padding:0 0.3rem; }
.filtros-container button { height:32px; font-size:0.9rem; padding:0 0.6rem; }

.chart-desc {
  font-size:0.85rem;
  font-weight:600;
  text-align:center;
  margin-bottom:0.3rem;
  color:#333;
}
</style>
</head>
<body>

<div class="container">

  <!-- HEADER -->
  <div class="header">
    <div>
      <div class="title">Reporte General — Todos los Gestores</div>
      <small class="text-muted">Detalle Total de Recuperaciones y Gestiones</small>
    </div>
    <button class="btn btn-secondary" onclick="history.back()">← Regresar</button>
  </div>

  <!-- INTRODUCCIÓN -->
  <p>
    Este reporte mensual presenta un análisis detallado de los avances en la gestión de cobros de todos los gestores. 
    Incluye información consolidada de montos recuperados, créditos gestionados y cumplimiento de objetivos por mes, 
    permitiendo identificar tendencias, desempeño individual y global, así como áreas de mejora.
  </p>

  <!-- NUEVA TABLA: GESTIONES POR EMPLEADO -->
  <div class="filtros-container">
    <label for="filterMes">Filtrar por Mes:</label>
    <select id="filterMes" onchange="updateGestionesTabla()">
      <option value="Todos">Todos los meses</option>
    </select>
  </div>

  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-white"><strong>Gestiones por Empleado</strong></div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-sm mb-0">
          <thead class="thead-dark">
            <tr>
              <th>Mes</th>
              <th>Gestor</th>
              <th>Llamada</th>
              <th>WhatsApp</th>
              <th>Correo</th>
              <th>Avisos</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody id="gestionesTbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-md-6 mb-3">
      <div class="chart-desc">Total de Gestiones por Empleado</div>
      <canvas id="chartGestionesEmpleados" class="grafico"></canvas>
    </div>
    <div class="col-md-6 mb-3">
      <div class="chart-desc">Tendencia Mensual de Gestiones Totales</div>
      <canvas id="chartGestionesLinea" class="grafico"></canvas>
    </div>
  </div>

  <!-- FILTROS Y TABLA CONSOLIDADO ORIGINAL -->
  <div class="filtros-container">
    <label for="filterDesde">Desde:</label>
    <input type="month" id="filterDesde">
    <label for="filterHasta">Hasta:</label>
    <input type="month" id="filterHasta">
    <button class="btn btn-primary btn-sm" onclick="loadAll()">Aplicar Filtro</button>
  </div>

  <!-- KPI -->
  <div class="d-flex flex-wrap gap-2 mb-3">
    <div class="card-kpi bg-rec"><small>Recuperado</small><div id="kpiRec">$0.00</div></div>
    <div class="card-kpi bg-obj"><small>Objetivo</small><div id="kpiObj">$10,000.00</div></div>
    <div class="card-kpi bg-fal"><small>Faltante</small><div id="kpiFal">$0.00</div></div>
    <div class="card-kpi bg-por"><small>% Recuperado</small><div id="kpiPor">0%</div></div>
  </div>

  <!-- TABLA CONSOLIDADO -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-white"><strong>Consolidado de Gestiones por Mes</strong></div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-sm mb-0">
          <thead class="thead-dark">
            <tr>
              <th>Mes</th>
              <th>Recuperado</th>
              <th>Faltante</th>
              <th>Objetivo</th>
              <th>Créditos</th>
              <th>Gestiones</th>
              <th>% Recuperado</th>
            </tr>
          </thead>
          <tbody id="consolidadoTbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- GRÁFICOS CONSOLIDADO -->
  <div class="row mb-4">
    <div class="col-md-4 mb-3">
      <div class="chart-desc">Distribución del monto recuperado por mes</div>
      <canvas id="chartPie" class="grafico"></canvas>
    </div>
    <div class="col-md-4 mb-3">
      <div class="chart-desc">Comparativo de Recuperado vs Objetivo por mes</div>
      <canvas id="chartBar" class="grafico"></canvas>
    </div>
    <div class="col-md-4 mb-3">
      <div class="chart-desc">Tendencia mensual de recuperación y cumplimiento de objetivos</div>
      <canvas id="chartLine" class="grafico"></canvas>
    </div>
  </div>

</div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
// -------------------------
// CONFIG
// -------------------------
const proxy = "https://api.codetabs.com/v1/proxy?quest=";
const sheetGestiones = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSWc7tNf1MsbdXNCf7_To0EUb25mXuEE-SnH4wg3_cd7Xa_-kYQNJXOvS6vAbzr9EGNOCyI8bw4KIwE/pub?gid=174846463&single=true&output=csv";
const sheetRecuperado = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTh4nQC1nPAHgWvJ0SIlL5AhnV4d6v6htBlGQnCJsLvLeC1IsfYDglzJ1JyVKvRAJ6apOEocWmvpsKo/pub?gid=1552374160&single=true&output=csv";
const OBJETIVO_TOTAL = 10000;

// -------------------------
// UTILIDADES
// -------------------------
function money(v){ return `$${Number(v||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}`; }
function parseCSV(text){
  const rows = text.trim().split("\n").map(r => r.split(",").map(c => c.trim()));
  const headers = rows.shift();
  return rows.map(r => {
    const obj = {};
    headers.forEach((h,i) => obj[h.trim()] = r[i] ? r[i].trim() : "");
    return obj;
  });
}

// -------------------------
// GESTIONES POR EMPLEADO
// -------------------------
let gestionesData = [];
let chartEmpleados, chartLinea;
const mesesOrden = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];

async function loadGestiones(){
  try{
    const res = await fetch(proxy + encodeURIComponent(sheetGestiones));
    gestionesData = parseCSV(await res.text());

    // llenar filtro meses
    const meses = [...new Set(gestionesData.map(g=>g.MES).filter(m=>m))];
    const filter = document.getElementById("filterMes");
    mesesOrden.forEach(m=>{
      if(meses.includes(m)){
        const opt = document.createElement("option");
        opt.value = m; opt.textContent = m;
        filter.appendChild(opt);
      }
    });

    updateGestionesTabla();
  }catch(e){ console.error(e); alert("Error cargando gestiones"); }
}

function updateGestionesTabla(){
  const mesSeleccionado = document.getElementById("filterMes").value;
  const tbody = document.getElementById("gestionesTbody");
  tbody.innerHTML="";

  const empleados = {};
  gestionesData.forEach(g=>{
    if(mesSeleccionado!=="Todos" && g.MES!==mesSeleccionado) return;
    const gest = g.GESTION.trim();
    const gestor = g.GESTOR.trim();
    if(!empleados[gestor]) empleados[gestor]={Llamada:0,WhatsApp:0,Correo:0,Avisos:0};
    if(gest.toLowerCase().includes("llamada")) empleados[gestor].Llamada++;
    else if(gest.toLowerCase().includes("whatsapp")) empleados[gestor].WhatsApp++;
    else if(gest.toLowerCase().includes("correo")) empleados[gestor].Correo++;
    else if(gest.toLowerCase().includes("aviso")) empleados[gestor].Avisos++;
  });

  for(const [gestor, vals] of Object.entries(empleados)){
    const total = vals.Llamada + vals.WhatsApp + vals.Correo + vals.Avisos;
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${mesSeleccionado}</td><td>${gestor}</td><td>${vals.Llamada}</td><td>${vals.WhatsApp}</td><td>${vals.Correo}</td><td>${vals.Avisos}</td><td>${total}</td>`;
    tbody.appendChild(tr);
  }

  // Gráfico barras
  const labels = Object.keys(empleados);
  const dataTotales = Object.values(empleados).map(v=>v.Llamada+v.WhatsApp+v.Correo+v.Avisos);
  const ctx = document.getElementById("chartGestionesEmpleados").getContext("2d");
  if(chartEmpleados) chartEmpleados.destroy();
  chartEmpleados = new Chart(ctx,{ type:"bar", data:{labels,datasets:[{label:"Total de Gestiones", data:dataTotales, backgroundColor:"#28a745"}]}, options:{indexAxis:'y', plugins:{legend:{display:false}}} });

  // Gráfico línea total mensual
  const totalMeses = mesesOrden.map(m=>gestionesData.filter(g=>g.MES===m).length);
  const ctx2 = document.getElementById("chartGestionesLinea").getContext("2d");
  if(chartLinea) chartLinea.destroy();
  chartLinea = new Chart(ctx2,{ type:"line", data:{labels:mesesOrden, datasets:[{label:"Gestiones Totales", data:totalMeses, borderColor:"#0d6efd", fill:false}]} });
}

// -------------------------
// CONSOLIDADO ORIGINAL
// -------------------------
async function loadAll(){
  await loadGestiones(); // primero cargar la tabla superior
  try{
    const desde = document.getElementById('filterDesde').value;
    const hasta = document.getElementById('filterHasta').value;

    const gestionesRes = await fetch(proxy + encodeURIComponent(sheetGestiones));
    const recuperadoRes = await fetch(proxy + encodeURIComponent(sheetRecuperado));

    const gestiones = parseCSV(await gestionesRes.text());
    const recuperado = parseCSV(await recuperadoRes.text());

    const filtradosRec = recuperado.filter(r=>{
      if(!r["MES"]) return false;
      if(desde && r["MES"] < desde) return false;
      if(hasta && r["MES"] > hasta) return false;
      return true;
    });

    const filtradosGest = gestiones.filter(r=>{
      if(!r["MES"]) return false;
      if(desde && r["MES"] < desde) return false;
      if(hasta && r["MES"] > hasta) return false;
      return true;
    });

    const meses = [...new Set([...filtradosRec.map(d=>d["MES"]), ...filtradosGest.map(d=>d["MES"])]).values()]
      .filter(m => m)
      .sort((a,b) => mesesOrden.indexOf(a) - mesesOrden.indexOf(b));

    const consolidado = meses.map(m=>{
      const pagosMes = filtradosRec.filter(d=>d["MES"]===m);
      const gestionesMes = filtradosGest.filter(d=>d["MES"]===m);

      const totalRec = pagosMes.reduce((s,p)=>{
        let monto = p["RECUPERADO"] || "0";
        monto = monto.replace(/\$/g,'').replace(/,/g,'').trim();
        return s + Number(monto || 0);
      },0);

      const objetivo = OBJETIVO_TOTAL;
      return {
        MES: m,
        RECUPERADO: totalRec,
        OBJETIVO: objetivo,
        FALTANTE: Math.max(0, objetivo - totalRec),
        CREDITOS: gestionesMes.length,
        GESTIONES: gestionesMes.length,
        PORC: ((totalRec/objetivo)*100).toFixed(1)
      };
    });

    renderTable(consolidado);
    renderCharts(consolidado);

  } catch(e){ console.error("Error cargando datos:", e); alert("No se pudieron cargar los datos del reporte."); }
}

// -------------------------
// RENDER TABLA CONSOLIDADO
// -------------------------
function renderTable(data){
  const tbody = document.getElementById("consolidadoTbody");
  tbody.innerHTML = "";
  data.forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.MES}</td>
      <td>${money(r.RECUPERADO)}</td>
      <td>${money(r.FALTANTE)}</td>
      <td>${money(r.OBJETIVO)}</td>
      <td>${r.CREDITOS}</td>
      <td>${r.GESTIONES}</td>
      <td>${r.PORC>=85 ? `<span class='indicator-ok'>${r.PORC}%</span>` : `<span class='indicator-bad'>${r.PORC}%</span>`}</td>
    `;
    tbody.appendChild(tr);
  });

  const totalRec = data.reduce((s,d)=>s+Number(d.RECUPERADO),0);
  const totalObj = data.reduce((s,d)=>s+Number(d.OBJETIVO),0);
  const totalFal = Math.max(0,totalObj-totalRec);
  const porc = totalObj ? ((totalRec/totalObj)*100).toFixed(1) : 0;
  document.getElementById("kpiRec").textContent = money(totalRec);
  document.getElementById("kpiObj").textContent = money(totalObj);
  document.getElementById("kpiFal").textContent = money(totalFal);
  document.getElementById("kpiPor").textContent = porc+"%";
}

// -------------------------
// GRÁFICOS CONSOLIDADO
// -------------------------
let chartPie, chartBar, chartLine;
function renderCharts(data){
  const ctxPie = document.getElementById('chartPie').getContext('2d');
  const ctxBar = document.getElementById('chartBar').getContext('2d');
  const ctxLine = document.getElementById('chartLine').getContext('2d');

  if(chartPie) chartPie.destroy();
  if(chartBar) chartBar.destroy();
  if(chartLine) chartLine.destroy();

  chartPie = new Chart(ctxPie,{type:'pie',data:{labels:data.map(d=>d.MES), datasets:[{data:data.map(d=>d.RECUPERADO)}]}, options:{plugins:{legend:{position:'bottom'}, tooltip:{callbacks:{label:function(ctx){return money(ctx.raw);}}}}}});
  chartBar = new Chart(ctxBar,{type:'bar',data:{labels:data.map(d=>d.MES), datasets:[{label:'Recuperado',data:data.map(d=>d.RECUPERADO), backgroundColor:'#28a745'},{label:'Objetivo', data:data.map(d=>d.OBJETIVO), backgroundColor:'#0d6efd'}]}});
  chartLine = new Chart(ctxLine,{type:'line',data:{labels:data.map(d=>d.MES), datasets:[{label:'Recuperado',data:data.map(d=>d.RECUPERADO), borderColor:'#28a745', fill:false},{label:'Objetivo', data:data.map(d=>d.OBJETIVO), borderColor:'#0d6efd', fill:false}]}});
}

document.addEventListener("DOMContentLoaded", loadAll);
</script>

</body>
</html>
